name: Generate sitemap and validate robots

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

env:
  SITE_URL: "https://kramorant.github.io" # Cambia si usas dominio personalizado
  SITEMAP_PATH: "sitemap.xml"
  ROBOTS_PATH: "robots.txt"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Ensure robots.txt exists (fail if missing)
        id: check-robots
        run: |
          if [ -f "${{ env.ROBOTS_PATH }}" ]; then
            echo "robots.txt found."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "robots.txt not found."
            echo "exists=false" >> $GITHUB_OUTPUT
            # Si prefieres que el workflow cree un robots.txt por defecto en lugar de fallar,
            # descomenta las siguientes líneas y comenta la línea 'exit 1' para auto-crear.
            #
            # cat > "${{ env.ROBOTS_PATH }}" <<'EOF'
            # User-agent: *
            # Disallow:
            # Sitemap: ${{ env.SITE_URL }}/sitemap.xml
            # EOF
            #
            # git add "${{ env.ROBOTS_PATH }}"
            # git commit -m "chore: add default robots.txt (generated by workflow)" || echo "no changes to commit"
            #
            exit 1

      - name: Generate sitemap.xml from HTML files
        id: gen-sitemap
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const { execSync } = require('child_process');

          const siteUrl = process.env.SITE_URL.replace(/\/$/, '');
          const sitemapPath = process.env.SITEMAP_PATH || 'sitemap.xml';

          // Recorrer archivos .html
          function walk(dir) {
            let results = [];
            const list = fs.readdirSync(dir);
            list.forEach(function(file) {
              file = path.join(dir, file);
              const stat = fs.statSync(file);
              if (stat && stat.isDirectory()) {
                results = results.concat(walk(file));
              } else {
                if (file.endsWith('.html')) results.push(file);
              }
            });
            return results;
          }

          const htmlFiles = walk(process.cwd())
            .map(f => path.relative(process.cwd(), f))
            .filter(f => !f.startsWith('.git/'));

          // Obtener fecha de último commit por archivo
          function lastMod(file) {
            try {
              const out = execSync('git log -1 --format=%cI -- ' + JSON.stringify(file)).toString().trim();
              return out || new Date().toISOString();
            } catch (e) {
              return new Date().toISOString();
            }
          }

          const urls = htmlFiles.map(f => {
            const loc = f === 'index.html' ? '/' : '/' + f.replace(/\\/g, '/');
            return {
              loc: siteUrl + loc,
              lastmod: lastMod(f)
            };
          });

          const xmlItems = urls.map(u => \`
  <url>
    <loc>\${u.loc}</loc>
    <lastmod>\${u.lastmod}</lastmod>
    <changefreq>monthly</changefreq>
    <priority>0.80</priority>
  </url>\`).join('\\n');

          const xml = '<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n' +
            '<urlset xmlns=\"https://www.sitemaps.org/schemas/sitemap/0.9\">\\n' +
            xmlItems + '\\n</urlset>\\n';

          const prev = fs.existsSync(sitemapPath) ? fs.readFileSync(sitemapPath,'utf8') : null;
          if (prev !== xml) {
            fs.writeFileSync(sitemapPath, xml, 'utf8');
            console.log('Sitemap updated: ' + sitemapPath);
            process.exitCode = 0;
          } else {
            console.log('No changes to sitemap.');
            process.exitCode = 0;
          }
          "

      - name: Commit and push sitemap if changed
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ env.SITEMAP_PATH }}" || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update sitemap.xml (generated by workflow)" || echo "commit failed"
            git push origin HEAD:${{ github.ref_name }}
          fi
